# 系统架构 - 人员跟踪系统

> 本文档是 ARCHITECTURE.md 的中文翻译版本

## 目录
1. [概述](#概述)
2. [系统架构](#系统架构)
3. [组件设计](#组件设计)
4. [数据流](#数据流)
5. [模块结构](#模块结构)
6. [设计模式](#设计模式)
7. [技术栈](#技术栈)

---

## 概述

人员跟踪系统是一个全面的多目标跟踪（MOT）系统，设计用于视频序列的实时和批量处理。系统集成了基于深度学习的检测、最先进的跟踪算法和生产级部署基础设施。

### 关键特性
- **模块化设计**：松耦合组件，接口清晰
- **可扩展性**：易于添加新的跟踪算法和功能
- **生产就绪**：包含API、Web UI和Docker部署
- **研究导向**：包含新颖的基于Transformer的跟踪器

---

## 系统架构

### 高层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层                                    │
├─────────────────────────────────────────────────────────────┤
│  Web UI (Streamlit)  │  REST API (FastAPI)  │  CLI工具      │
└──────────────────────┬───────────────────────┬─────────────┘
                       │                       │
                       ▼                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    推理层                                     │
├─────────────────────────────────────────────────────────────┤
│  视频处理器  │  DeepSORT跟踪器  │  结果导出器                │
└────────────────────┬───────────────────────┬───────────────┘
                     │                       │
                     ▼                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    模型层                                     │
├─────────────────────────────────────────────────────────────┤
│  检测 (YOLOv8)  │  ReID模型  │  Transformer跟踪器           │
└──────────────────────┬───────────────────────┬──────────────┘
                       │                       │
                       ▼                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    核心算法层                                 │
├─────────────────────────────────────────────────────────────┤
│  卡尔曼滤波器  │  匈牙利算法  │  特征提取                    │
└─────────────────────────────────────────────────────────────┘
```

详细内容请参考英文版 `ARCHITECTURE.md`。

---

## 组件设计

### 1. 检测模块 (`src/models/detection/`)

**目的**：在视频帧中检测人员

**组件**：
- `yolo_detector.py`: YOLOv8集成包装器

**关键特性**：
- 可配置置信度阈值
- 非极大值抑制（NMS）
- 批处理支持
- GPU加速

---

### 2. 跟踪模块 (`src/models/tracking/`)

**目的**：跨帧跟踪检测到的对象

#### 2.1 DeepSORT跟踪器 (`deepsort.py`)

**核心组件**：

1. **KalmanFilter类**
   - 状态：`[x, y, a, h, vx, vy, va, vh]`
   - 8维状态向量
   - 恒定速度运动模型

2. **Track类**
   - 管理单个轨迹生命周期
   - 状态：Tentative → Confirmed → Deleted
   - 特征库管理

3. **DeepSORT类**
   - 主跟踪协调器
   - 级联匹配策略
   - IoU回退匹配
   - 外观特征匹配

---

### 3. ReID模块 (`src/models/reid/`)

**目的**：提取判别性外观特征

**架构**：
- **骨干网络**：ResNet50（ImageNet预训练）
- **注意力**：通道注意力机制
- **特征维度**：2048
- **损失函数**：三元组损失 + 交叉熵损失

---

## 数据流

### 跟踪流水线

```
帧输入
    │
    ├─► 检测 (YOLOv8)
    │   └─► [bbox, confidence] × N
    │
    ├─► 特征提取
    │   ├─► ReID模型（如果可用）
    │   └─► 颜色直方图（回退）
    │   └─► 特征向量 × N
    │
    ├─► 轨迹预测（卡尔曼滤波器）
    │   └─► 预测状态 × M
    │
    ├─► 关联（DeepSORT）
    │   ├─► 级联匹配
    │   ├─► IoU匹配
    │   └─► 匈牙利算法
    │   └─► 匹配： (track_idx, detection_idx)
    │
    ├─► 轨迹更新
    │   ├─► 更新匹配的轨迹（卡尔曼 + 特征）
    │   ├─► 创建新轨迹（未匹配的检测）
    │   └─► 删除旧轨迹（超过max_age）
    │
    └─► 输出
        ├─► 标注帧
        └─► 跟踪数据（JSON）
```

---

## 模块结构

```
src/
├── api/                    # REST API服务器
│   ├── main.py            # 基础API
│   └── production_api.py  # 生产API（Celery + Redis）
│
├── inference/              # 视频处理
│   ├── main.py            # CLI接口
│   └── deepsort_tracker.py # DeepSORT集成
│
├── models/
│   ├── detection/         # 检测模型
│   ├── tracking/          # 跟踪算法
│   ├── reid/              # 重识别
│   └── analysis/          # 分析工具
│
├── training/              # 训练脚本
├── evaluation/            # 评估指标
├── data/                  # 数据加载器
├── applications/          # 领域应用
├── ui/                    # Web界面
└── utils/                 # 工具函数
```

---

## 技术栈

### 核心库
- **PyTorch**: 深度学习框架
- **Ultralytics YOLOv8**: 目标检测
- **OpenCV**: 视频处理和可视化
- **NumPy**: 数值计算
- **SciPy**: 优化算法（匈牙利算法）

### Web和API
- **FastAPI**: REST API框架
- **Streamlit**: Web UI框架
- **Celery**: 后台任务处理
- **Redis**: 任务队列和缓存

### 部署
- **Docker**: 容器化
- **Docker Compose**: 多容器编排
- **Nginx**: 反向代理（生产环境）

---

*文档版本：1.0*  
*最后更新：2025-11-22*  
*系统版本：最终优化版*

**完整英文版请参考：`ARCHITECTURE.md`**

